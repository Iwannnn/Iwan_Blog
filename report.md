网站: iwannnn.cn
# 初期准备

## 开发环境说明 

本项目采用VSCode作为开发工具，开发环境系统平台位Windows 10 ，Python版本位3.9.0 ，Django版本为3.1.6 ，采用编VSCode作为开发工具，数据库为Django自带的sqlite。

## 虚拟环境的使用
使用虚拟环境对将网站部署到服务器上更加方便，在一个新的环境下运行一个独立的项目，这能够避免其他已经安装的模块可能与本项目产生冲突的麻烦。

使用pipenv创建和管理虚拟环境```pip install pipenv```，在选择创建项目的文件夹的根目录下执行```pipenv install```，激活虚拟环境可以使用```pipenv shell``` 或 ``` pipenv run ``` 在我使用的VSCode可以直接将虚拟环境选择为默认的环境，这样在使用pip时就没有什么变化，但是，在安装包时pipfile 和 piplock里面的数据并不会同时更改，这让我在后期部署时产生了麻烦，需要重新导出requirements.txt文件进行环境的配置。而在```pipenv install```下使用pip，pipfile和piplock中的文件就会同时更改这才达成方便部署的目的。

## 建立Django项目

1. 先安装对应的Django版本进入根目录运行命令 ```pipenv install django``` 
2. 建立Django工程 在项目根目录下运行 ```pipenv run django-admin startproject blogproject```

# 代码实现

实现网站的基本代码

## blogproject

关于整个django项目的基础代码

### settings

为了部署和开发的方便将settings文件拆开成为common，loacl，production三个文件，这样在部署完后的开发过程中不用更改代码。在拆分掉settings文件后需要更改manage和wsgi中settings文件的路径。

#### common

```python
"""
Django settings for blogproject project.

Generated by 'django-admin startproject' using Django 3.1.3.

For more information on this file, see
https://docs.djangoproject.com/en/3.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.1/ref/settings/
"""

from pathlib import Path
import os
# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent.parent


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    'imagekit',  # image处理
    'crispy_forms',  # 表单
    'pure_pagination',  # 分页
    'mdeditor',  # markdown 编辑器
    'mptt',  # 树形结构 次级评论
    'notifications',  # 通知
    'notice.apps.NoticeConfig',  # 注册 notice 应用
    'blog.apps.BlogConfig',  # 注册 blog 应用
    'comments.apps.CommentsConfig',  # 注册 comments 应用
    'interface.apps.InterfaceConfig',  # 注册 interface 应用
    'accounts.apps.AccountsConfig',  # 注册 account 应用
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'blogproject.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'blogproject.wsgi.application'
CRISPY_TEMPLATE_PACK = 'bootstrap'

# Database
# https://docs.djangoproject.com/en/3.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': str(os.path.join(BASE_DIR, "db.sqlite3"))
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

PAGINATION_SETTINGS = {
    'PAGE_RANGE_DISPLAYED': 4,  # 分页条当前页前后应该显示的总页数（两边均匀分布，因此要设置为偶数），
    'MARGIN_PAGES_DISPLAYED': 2,  # 分页条开头和结尾显示的页数
    'SHOW_FIRST_PAGE_WHEN_INVALID': True,  # 当请求了不存在页，显示第一页
}


# Internationalization
# https://docs.djangoproject.com/en/3.1/topics/i18n/


LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.1/howto/static-files/

X_FRAME_OPTIONS = 'SAMEORIGIN'

MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
MEDIA_URL = '/media/'

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')

```

#### local

```python
# SECURITY WARNING: keep the secret key used in production secret!
from .common import *

SECRET_KEY = 'development-secret-key'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']

``` 

#### production

```python
# SECURITY WARNING: keep the secret key used in production secret!
from .common import *

SECRET_KEY = os.environ['DJANGO_SECRET_KEY']

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = False

ALLOWED_HOSTS = ['127.0.0.1', 'localhost ', '.iwannnn.cn', '47.98.63.97']

```

### urls

```python
"""blogproject URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/3.1/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include
from blog.feeds import AllPostsRssFeed
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('blog.urls')),
    path('', include('comments.urls')),
    path('', include('interface.urls')),
    path('', include('accounts.urls')),
    path('', include('notice.urls')),
    path('mdeditor/', include('mdeditor.urls')),
    path('sidebar/', include('sidebar.urls')),
    path('notifications/', include('notifications.urls')),
    path('all/rss/', AllPostsRssFeed(), name='rss'),
]

urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

```

通过导入的include函数将其中的内容与path中第一个参数相连接，从而实现访问。

## blog

博客文章代码

### templatetags

使用自定义的模板标签，模板标签本质上就是一个python函数，因此按照python函数的思路来编写模板标签的代码就可以了

#### blog_extras

```python
from django import template
from ..models import Post, Category, Tag
from django.db.models.aggregates import Count
from blog.models import Category
register = template.Library()  # 实例化


# 装饰函数
# take_contexts 传入模板变量和父模板
# 最近文章
@register.inclusion_tag('blog/inclusions/_recent_posts.html', takes_context=True)
def show_recent_posts(context, num=5):
    return {
        'recent_post_list': Post.objects.all().order_by('-created_time')[:num]
    }

# 归档模板


@register.inclusion_tag('blog/inclusions/_archives.html', takes_context=True)
def show_archives(context):
    return {
        'date_list': Post.objects.dates('created_time', 'month', order='DESC'),
    }

# 分类模板


@register.inclusion_tag('blog/inclusions/_categories.html', takes_context=True)
def show_categories(context):
    category_list = Category.objects.annotate(
        num_posts=Count('post')).filter(num_posts__gt=0)
    return {
        'category_list': category_list,
    }

# 标签模板


@register.inclusion_tag('blog/inclusions/_tags.html', takes_context=True)
def show_tags(context):
    tag_list = Tag.objects.annotate(
        num_posts=Count('post')).filter(num_posts__gt=0)
    return {
        'tag_list': tag_list,
    }

```


### admin
修改admin下显示的内容。
```python
from django.contrib import admin
from .models import Post, Category, Tag
from django.utils import timezone

# Register your models here.


class PostAdmin (admin.ModelAdmin):
    list_display = ['title', 'created_time',
                    'modified_time', 'views', 'category', 'author']
    fields = ['title', 'body', 'image', 'summary', 'category', 'tags']

    def save_model(self, request, obj, form, change):
        obj.author = request.user
        return super().save_model(request, obj, form, change)


admin.site.register(Post, PostAdmin)
admin.site.register(Category)
admin.site.register(Tag)

```

### app

```python
from django.apps import AppConfig


class BlogConfig(AppConfig):
    name = 'blog'
    verbose_name = '博客'

```

### feeds
使用django的feed类生成规范化的XML文档，实现RSS订阅功能。
```python
from django.contrib.syndication.views import Feed
from .models import Post


class AllPostsRssFeed(Feed):
    # 显示在聚合阅读器上的标题
    title = "Iwan-Blog"

    # 通过聚合阅读器跳转到网站的地址
    link = "/"

    # 显示在聚合阅读器上的描述信息
    description = "Iwan-Blog 全部文章"

    # 需要显示的内容条目
    def items(self):
        return Post.objects.all()

    # 聚合器中显示的内容条目的标题
    def item_title(self, item):
        return "[%s] %s" % (item.category, item.title)

    # 聚合器中显示的内容条目的描述
    def item_description(self, item):
        return item.body_html

```

### models

博客的文章应该有id、标题、正文、作者、发表时间、最近修改时间、标题图等，还会有他对应的评论、分类、标签等。博客文章对映的数据库表结构如下：

| 文章id | 标题  | 正文 | 发表时间 | 标题图 | 分类     | 标签 |
| :----- | :---- | :--- | :------- | :----- | :------- | :--- |
| 1      | title | text | time     | jpg    | category | tage |
| 2      | title | text | time     | jpg    | category | tage |

先注册blog应用，django会自己生成一个blog文件夹，在model.py中的代码如下，是设计数据库模型的代码。再将blog注册到settings.py文件。

```python
from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone
from django.urls import reverse
from django.utils.html import strip_tags
from django.utils.text import slugify
from markdown.extensions.toc import TocExtension
from django.utils.functional import cached_property
from imagekit.models import ImageSpecField
from imagekit.processors import ResizeToFill
from mdeditor.fields import MDTextField
import re
import markdown
import emoji
from markdown import extensions
# Create your models here.


class Category(models.Model):
    name = models.CharField(max_length=100)

    class Meta:
        verbose_name = "分类"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name


class Tag(models.Model):
    name = models.CharField(max_length=100)

    class Meta:
        verbose_name = "标签"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name


class Post(models.Model):
    title = models.CharField('标题', max_length=100)
    body = MDTextField('正文')
    created_time = models.DateTimeField('创建时间', default=timezone.now)
    modified_time = models.DateTimeField('修改时间')
    summary = models.CharField('摘要', max_length=200, blank=True)
    category = models.ForeignKey(
        Category, verbose_name='分类', on_delete=models.CASCADE)
    # 实现一个类型对应多个文章（一对多） 级联删除
    tags = models.ManyToManyField(Tag, verbose_name='标签', blank=True)
    # 实现一个标签对应多个文章 一个文章对应对各标签（多对多）
    author = models.ForeignKey(
        User, verbose_name='作者', on_delete=models.CASCADE)
    # 实现一个作者对应多个文章（一对多） 级联删除
    views = models.PositiveIntegerField(default=0, editable=False)
    image = models.ImageField(upload_to='post/%Y%m%d/', blank=True)
    likes = models.PositiveIntegerField(default=0)
    image_resize = ImageSpecField(
        source="image",
        processors=[ResizeToFill(600, 400)],  # 处理后的图像大小
        format='JPEG',  # 处理后的图片格式
        options={'quality': 95}  # 处理后的图片质量
    )

    class Meta:
        ordering = ("-created_time",)
        verbose_name = "文章"
        verbose_name_plural = verbose_name

    def save(self, *args, **kwargs):
        self.modified_time = timezone.now()
        md = markdown.Markdown(extensions=[
            'markdown.extensions.extra',
            'markdown.extensions.codehilite',
            'markdown.extensions.toc',  # 自动生成目录
            TocExtension(slugify=slugify),
        ])
        self.summary = strip_tags(md.convert(self.body))[:122]
        super().save(*args, **kwargs)

    def get_absolute_url(self):  # 生成url
        return reverse('blog:detail', kwargs={'pk': self.pk})

    def increase_views(self):
        self.views += 1
        self.save(update_fields=['views'])

    @property
    def toc(self):
        return self.rich_content.get("toc", "")

    @property
    def body_html(self):
        return self.rich_content.get("content", "")

    @cached_property
    def rich_content(self):  # 以属性访问的形式获取返回值 提供缓存功能
        return generate_rich_content(self.body)

    def __str__(self):
        return self.title


def generate_rich_content(value):
    md = markdown.Markdown(
        extensions=[
            "markdown.extensions.extra",
            "markdown.extensions.codehilite",
            # 记得在顶部引入 TocExtension 和 slugify
            TocExtension(slugify=slugify),
        ]
    )
    content = md.convert(value)
    content = emoji.emojize(content, use_aliases=True)
    m = re.search(r'<div class="toc">\s*<ul>(.*)</ul>\s*</div>', md.toc, re.S)
    toc = m.group(1) if m is not None else ""
    return {"content": content, "toc": toc}

```

在写好数据库模型的代码后，他还只是python的代码，django还没将他翻译为数据库语言，需要运行 ``` pipenv run python manage.py makemigrations ``` 和 ```pipenv run python manage.py migrate```。


### urls


在blog应用下创建文件urls.py并写入:
```python
from django.urls import path
from . import views

app_name = 'blog'  # 视图函数命名空间
urlpatterns = [
    path('', views.IndexView.as_view(), name='index'),
    path('posts/<int:pk>/', views.PostDetailView.as_view(), name='detail'),
    path('archives/<int:year>/<int:month>/',
         views.ArchiveView.as_view(), name='archive'),
    path('categories/<int:pk>/', views.CategoryView.as_view(), name='category'),
    path('tags/<int:pk>/', views.TagView.as_view(), name='tag'),
    path('increase_likes/<int:id>/',
         views.PostLikesView.as_view(), name='increase_likes'),
    path('search/', views.search, name='search')
]
```

从django.urls导入path函数，又导入当前目录下的views模块，再把网址和处理函数的关系写在urlpatterns中。绑定关系的写法是将网址和对应的处理函数作为参数传给path函数，第一个参数为网址，第二个参数为处理函数，额外传入name参数，将作为别名。

### views

```python
from .models import Post, Category, Tag
from django.shortcuts import get_object_or_404, render, redirect, HttpResponse
from django.views.generic import ListView, DetailView
from pure_pagination.mixins import PaginationMixin
from django.contrib import messages
from django.db.models import Q
# Create your views here.


# def index(request):
#     post_list = Post.objects.all().order_by('-created_time')
#     return render(request, 'blog/index.html', context={'post_list': post_list})


class IndexView(PaginationMixin, ListView):
    Post.objects.all().order_by('-created_time')
    model = Post  # 指定从数据库获取的模型
    template_name = 'blog/index.html'
    context_object_name = 'post_list'  # 保存到post_list中
    # 指定 paginate_by 属性后开启分页功能，其值代表每一页包含多少篇文章
    paginate_by = 10


class CategoryView(IndexView):
    def get_queryset(self):
        cate = get_object_or_404(Category, pk=self.kwargs.get('pk'))
        return super(IndexView, self).get_queryset().filter(category=cate)


class TagView(IndexView):
    def get_queryset(self):
        t = get_object_or_404(Tag, pk=self.kwargs.get('pk'))
        return super(IndexView, self).get_queryset().filter(tags=t)


class ArchiveView(IndexView):
    def get_queryset(self):
        return super(IndexView, self).get_queryset().filter(created_time__year=self.kwargs.get('year'),
                                                            created_time__month=self.kwargs.get('month'))


class PostLikesView(IndexView):
    def post(self, request, *args, **kwargs):
        post = Post.objects.get(id=kwargs.get('id'))
        post.likes += 1
        post.save()
        return HttpResponse('success')


class PostDetailView(DetailView):
    model = Post
    template_name = 'blog/detail.html'
    context_object_name = 'post'

    def get(self, request, *args, **kwargs):
        response = super(PostDetailView, self).get(request, *args, **kwargs)
        self.object.increase_views()
        return response

    # def get_object(self, queryset=None):
    #     post = super().get_object(queryset=None)
    #     md = markdown.Markdown(extensions=[
    #         'markdown.extensions.extra',
    #         'markdown.extensions.codehilite',
    #         TocExtension(slugify=slugify),
    #     ])
    #     post.body = md.convert(post.body)

    #     m = re.search(
    #         r'<div class="toc">\s*<ul>(.*)</ul>\s*</div>', md.toc, re.S)
    #     post.toc = m.group(1) if m is not None else ''
    #     return post


def search(request):
    q = request.GET.get('q')
    if not q:
        error_msg = "请输入搜索关键词"
        messages.add_message(request, messages.ERROR,
                             error_msg, extra_tags='danger')
        return redirect('blog:index')
    post_list = Post.objects.filter(
        Q(title__icontains=q) | Q(body__icontains=q))
    return render(request, 'blog/index.html', {'post_list': post_list})


# def detail(request, pk):  # 根据url捕获文章id
#     post = get_object_or_404(Post, pk=pk)  # 匹配id
#     md = markdown.Markdown(extensions=[
#         'markdown.extensions.extra',  # 基础扩展
#         'markdown.extensions.codehilite',  # 代码高亮
#         'markdown.extensions.toc',  # 自动生成目录
#         TocExtension(slugify=slugify),
#     ])
#     post.body = md.convert(post.body)
#     m = re.search(
#         r'<div class="toc">\s*<ul>(.*)</ul>\s*</div>', md.toc, re.S)
#     post.toc = m.group(1) if m is not None else ''
#     return render(request, 'blog/detail.html', context={'post': post})

# def archive(request, year, month):
#     post_list = Post.objects.filter(
#         created_time__year=year, created_time__month=month).order_by('-created_time')  # 使用filter过滤文章
#     return render(request, 'blog/index.html', context={'post_list': post_list})

# def category(request, pk):
#     cate = get_object_or_404(Category, pk=pk)
#     post_list = Post.objects.filter(category=cate).order_by('-created_time')
#     return render(request, 'blog/index.html', context={'post_list': post_list})

# def tag(request, pk):
#     t = get_object_or_404(Tag, pk=pk)
#     post_list = Post.objects.filter(tags=t).order_by('-created_time')
#     return render(request, 'blog/index.html', context={'post_list': post_list})

```
视图函数有两种写法一种是直接写成函数的形式，另一种是写成类视图的样子，类视图具有代码复用等好处，也是Django官方推荐的方式。
## comments

文章下评论的代码

### templates

评论应用下的自定义标签模板

#### comments_extras

```python
from django import template
from ..forms import commentform

register = template.library()


@register.inclusion_tag('comments/inclusions/_form.html', takes_context=true)
def show_comment_form(context, post, form=none, parent_comment=none):
    if form is none:
        form = commentform()
    return {
        'form': form,
        'post': post,
    }


@register.inclusion_tag('comments/inclusions/_list.html', takes_context=true)
def show_comments(context, user, post, form=none):
    comment_list = post.comment_set.all().order_by(
        'tree_id', 'created_time')  # 获取全部评论
    comments_count = comment_list.count()
    if form is none:
        form = commentform()
    return {
        'comment_count': comments_count,
        'comment_list': comment_list,
        'form': form,
        'post': post,
        'user': user,
    }
```

### admin

注册comments到管理员页面中

```python
from django.contrib import admin
from .models import Comment

# Register your models here.


class CommentAdmin(admin.ModelAdmin):
    list_display = ['user', 'post', 'created_time']
    fields = ['user', 'text', 'post']


admin.site.register(Comment, CommentAdmin)

```

### apps

```python
from django.apps import AppConfig

class CommentsConfig(AppConfig):
    name = 'comments'
    verbose_name = '评论'
```

### forms

提交评论的表单

```python
from django import forms
from .models import Comment
from django.shortcuts import render, redirect


class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ['text']

```

### models

评论的数据库模型设计，利用MPTT，将评论树状连接，从而实现多级评论的效果。

```python
from django.db import models
from django.utils import timezone
from mdeditor.fields import MDTextField
from django.contrib.auth.models import User
from mptt.models import MPTTModel, TreeForeignKey
# Create your models here.


class Comment(MPTTModel):
    user = models.ForeignKey(
        User, verbose_name='用户名', on_delete=models.CASCADE)
    text = MDTextField('内容')
    created_time = models.DateTimeField('创建时间', default=timezone.now)
    post = models.ForeignKey(
        'blog.Post', verbose_name='文章', on_delete=models.CASCADE)  # 一个文章能有多个评论
    parent = TreeForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='children'
    )

    # 新增，记录二级评论回复给谁, str
    reply_to = models.ForeignKey(
        User,
        null=True,
        blank=True,
        on_delete=models.CASCADE,
        related_name='replyers'
    )

    class MPTTMeta:
        verbose_name = '评论'
        verbose_name_plural = verbose_name
        order_insertion_by = ['tree_id']

    def __str__(self):
        return '{}: {}'.format(self.user, self.text[:20])

```

### urls

```python
from django.urls import path
from . import views

app_name = 'comments'
urlpatterns = [
    path('comment/<int:post_pk>', views.comment, name='comment'),
    path('comment/<int:post_pk>/<int:parent_comment_id>',
         views.comment, name='comment_reply')
]

```

### views

评论的视图函数，其中添加了回复通知功能

```python
from django.shortcuts import render, get_object_or_404, redirect, HttpResponse, HttpResponseRedirect
from django.contrib.auth.models import User
from notifications.signals import notify
from blog.models import Post
from django.contrib import messages
from .forms import CommentForm
from .models import Comment
import accounts.models
import markdown
import emoji
# Create your views here.


def comment(request, post_pk, parent_comment_id=None):
    # 先获取被评论的文章，因为后面需要把评论和被评论的文章关联起来。
    # 这里我们使用了 django 提供的一个快捷函数 get_object_or_404，
    # 这个函数的作用是当获取的文章（Post）存在时，则获取；否则返回 404 页面给用户。
    post = get_object_or_404(Post, pk=post_pk)
    # django 将用户提交的数据封装在 request.POST 中，这是一个类字典对象。
    # 我们利用这些数据构造了 CommentForm 的实例，这样就生成了一个绑定了用户提交数据的表单。
    request.session['comment_from'] = request.META.get('HTTP_REFERER', '/')
    if request.method == 'POST':
        form = CommentForm(request.POST)
        if form.is_valid():
            # 检查到数据是合法的，调用表单的 save 方法保存数据到数据库，
            # commit=False 的作用是仅仅利用表单的数据生成 Comment 模型类的实例，但还不保存评论数据到数据库。
            comment = form.save(commit=False)
            comment.text = markdown.markdown(comment.text,
                                             extensions=[
                                                 'markdown.extensions.extra',
                                                 'markdown.extensions.codehilite',
                                                 'markdown.extensions.toc',
                                             ])
            comment.text = emoji.emojize(comment.text, use_aliases=True)
            # 将评论和被评论的文章关联起来。
            comment.user = request.user
            comment.post = post
            if parent_comment_id:
                parent_comment = Comment.objects.get(id=parent_comment_id)
                comment.parent_id = parent_comment.get_root().id
                # 被回复人
                comment.reply_to = parent_comment.user
                if not parent_comment.user.is_superuser and comment.user != comment.reply_to:
                    notify.send(
                        comment.user,
                        recipient=comment.reply_to,
                        verb='回复了你',
                        target=comment.post,
                        action_object=comment,
                    )
            # 最终将评论数据保存进数据库，调用模型实例的 save 方法
            comment.save()
            if not request.user.is_superuser and comment.user != comment.reply_to:
                notify.send(
                    request.user,
                    recipient=User.objects.filter(is_superuser=1),
                    verb='回复了你',
                    target=comment.post,
                    action_object=comment,
                )
            # 重定向到 post 的详情页，实际上当 redirect 函数接收一个模型的实例时，它会调用这个模型实例的 get_absolute_url 方法，
            # 然后重定向到 get_absolute_url 方法返回的 URL。
            messages.add_message(request, messages.SUCCESS,
                                 '评论发表成功', extra_tags='success')
            return redirect(post)
        # 检查到数据不合法，我们渲染一个预览页面，用于展示表单的错误。
        # 注意这里被评论的文章 post 也传给了模板，因为我们需要根据 post 来生成表单的提交地址。
        messages.add_message(request, messages.ERROR,
                             '发表评论失败', extra_tags='danger')
        return HttpResponseRedirect(request.session['comment_from'])

```

## accounts

用户登录app

### admin

注册账号应用

```python
from django.contrib import admin
from django.contrib.auth.models import User
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin

from .models import Profile
# Register your models here.


class ProfileInline(admin.StackedInline):
    model = Profile
    can_delete = False
    verbose_name = 'UserProfile'
    verbose_name_plural = verbose_name


class UserAdmin(BaseUserAdmin):
    inlines = (ProfileInline,)


admin.site.unregister(User)
admin.site.register(User, UserAdmin)
```

### apps

```python
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    name = 'accounts'
    verbose_name = '账号'
```

### forms

登录注册账号的表单,利用django已有的user。

```python
from django import forms
from django.contrib.auth.models import User
from .models import Profile


class LoginForm(forms.Form):
    username = forms.CharField(label="用户名", max_length=128)
    password = forms.CharField(
        label="密码", max_length=256, widget=forms.PasswordInput)


class RegisterForm(forms.ModelForm):
    # 复写 User 的密码
    password = forms.CharField()
    password2 = forms.CharField()

    class Meta:
        model = User
        fields = ('username',)


class ProfileForm(forms.ModelForm):
    class Meta:
        model = Profile
        fields = ('phone', 'email', 'img', 'bio')

```

### models

账号的数据库模型。

```python
from django.db import models
from django.contrib.auth.models import User
# 引入内置信号
from django.db.models.signals import post_save
# 引入信号接收器的装饰器
from django.dispatch import receiver

# Create your models here.

# 用户扩展信息


class Profile(models.Model):
    user = models.OneToOneField(
        User, on_delete=models.CASCADE, related_name='profile')
    phone = models.CharField(max_length=20, blank=True)
    email = models.EmailField(blank=True)
    img = models.ImageField(upload_to='img/%Y%m%d/', blank=True)
    bio = models.TextField(max_length=500, blank=True)

    def __str__(self):
        return 'user {}'.format(self.user.username)

```

### urls

```python
from django.urls import path
from . import views
from django.contrib import admin

app_name = "accounts"
urlpatterns = [
    path('login/', views.user_login, name='login'),
    path('register/', views.user_register, name='register'),
    path('logout/', views.user_logout, name='logout'),
    path('edit/<int:id>/', views.profile_edit, name='edit'),
]

```

### views

```python
from django.shortcuts import render, redirect, HttpResponse
from .forms import LoginForm, RegisterForm
from django.http import HttpResponseRedirect
from django.contrib import messages
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.models import User
from .forms import ProfileForm
from .models import Profile
# Create your views here.


def user_login(request):
    if request.method == 'GET':
        request.session['login_from'] = request.META.get('HTTP_REFERER', '/')
    if request.user.is_authenticated:
        messages.add_message(request, messages.SUCCESS,
                             '您已登录', extra_tags='success')
        return redirect("/")
    if request.method == 'POST':
        login_form = LoginForm(request.POST)
        if login_form.is_valid():
            data = login_form.cleaned_data
            try:
                user = User.objects.get(username=data['username'])
                if user.password == data['password']:
                    login(request, user)
                    messages.add_message(request, messages.SUCCESS,
                                         '登录成功', extra_tags='success')
                    return HttpResponseRedirect(request.session['login_from'])
                else:
                    messages.add_message(request, messages.ERROR,
                                         '密码错误', extra_tags='danger')
                    return render(request, 'accounts/login.html')
            except:
                messages.add_message(request, messages.ERROR,
                                     '用户不存在', extra_tags='danger')
        else:
            messages.add_message(request, messages.ERROR,
                                 '请检查填写的内容是否缺漏！', extra_tags='danger')
        return render(request, 'accounts/login.html')
    login_form = LoginForm()
    return render(request, 'accounts/login.html')


def user_register(request):
    if request.method == 'GET':
        request.session['register_from'] = request.META.get(
            'HTTP_REFERER', '/')
    if request.user.is_authenticated:
        messages.add_message(request, messages.SUCCESS,
                             '您已登录', extra_tags='success')
        return redirect("/")
    if request.method == "POST":
        register_form = RegisterForm(request.POST)
        if register_form.is_valid():  # 获取数据
            username = register_form.cleaned_data['username']
            password1 = register_form.cleaned_data['password']
            password2 = register_form.cleaned_data['password2']
            new_user = register_form.save(commit=False)
            # 设置密码
            if password1 != password2:  # 判断两次密码是否相同
                messages.add_message(request, messages.ERROR,
                                     '两次输入的密码不同！', extra_tags='danger')
                return render(request, 'accounts/register.html')
            else:
                same_username = User.objects.filter(username=username)
                if same_username:  # 用户名唯一
                    messages.add_message(request, messages.ERROR,
                                         '用户已经存在，请重新选择用户名！', extra_tags='danger')
                    return render(request, 'accounts/register.html')
            new_user.username = username
            new_user.password = password1
            new_user.save()
            # 保存好数据后立即登录并返回博客列表页面
            login(request, new_user)
            messages.add_message(request, messages.SUCCESS,
                                 '注册并登录成功', extra_tags='success')
            return HttpResponseRedirect(request.session['register_from'])
        else:
            messages.add_message(request, messages.ERROR,
                                 '用户已经存在，请重新选择用户名！', extra_tags='danger')
        return render(request, 'accounts/register.html')
    register_form = RegisterForm()
    return render(request, 'accounts/register.html')


def user_logout(request):
    # if request.method == 'GET':
    #     request.session['logout_to'] = request.META.get('HTTP_REFERER', '/')
    # if not request.session.get('is_login', None):
    #     # 如果本来就未登录，也就没有登出一说
    #     return HttpResponseRedirect(request.session['logout_to'])
    # # request.session.flush()
    logout(request)
    messages.add_message(request, messages.SUCCESS,
                         '登出成功', extra_tags='success')
    return redirect('/')


def profile_edit(request, id):
    if request.method == 'GET':
        request.session['edit_from'] = request.META.get(
            'HTTP_REFERER', '/')
    user = User.objects.get(id=id)
    # user_id 是 OneToOneField 自动生成的字段
    if Profile.objects.filter(user_id=id).exists():
        profile = Profile.objects.get(user_id=id)
    else:
        profile = Profile.objects.create(user=user)
    if request.method == 'POST':
        if request.user != user:
            messages.add_message(request, messages.ERROR,
                                 '你没有权限修改！', extra_tags='danger')
            return render(request, 'accounts/edit.html')
        profile_form = ProfileForm(request.POST, request.FILES)
        if profile_form.is_valid():
            # 取得清洗后的合法数据
            data = profile_form.cleaned_data
            if profile.phone != None:
                profile.phone = data['phone']
            if profile.email != None:
                profile.email = data['email']
            if profile.bio != None:
                profile.bio = data['bio']
            if 'img' in request.FILES:
                profile.img = data["img"]
            profile.save()
            # 带参数的 redirect()
            messages.add_message(request, messages.SUCCESS,
                                 '修改信息成功', extra_tags='success')
            return HttpResponseRedirect(request.session['edit_from'])
        else:
            messages.add_message(request, messages.ERROR,
                                 '输入信息不合法请重新输入！', extra_tags='danger')
            return render(request, 'accounts/edit.html')
    profile_form = ProfileForm()
    return render(request, 'accounts/edit.html')

```

## notice

通知应用

### apps

```python
from django.apps import AppConfig


class NoticeConfig(AppConfig):
    name = 'notice'
    verbose_name = '通知'

```

### urls 

```python
from django.urls import path
from . import views

app_name = 'notice'
urlpatterns = [
    # 通知列表
    path('list/', views.CommentNoticeListView.as_view(), name='list'),
    # 更新通知状态
    path('update/', views.CommentNoticeUpdateView.as_view(), name='update'),
]

```

### views

```python
from django.shortcuts import render, redirect
from django.views import View
from django.views.generic import ListView
from django.contrib.auth.mixins import LoginRequiredMixin
from blog.models import Post

# Create your views here.


class CommentNoticeListView(LoginRequiredMixin, ListView):
    """通知列表"""
    # 上下文的名称
    context_object_name = 'notices'
    # 模板位置
    template_name = 'notice/list.html'
    # 登录重定向
    login_url = '/accounts/login/'
    # 未读通知的查询集

    def get_queryset(self):
        return self.request.user.notifications.unread()


class CommentNoticeUpdateView(View):
    """更新通知状态"""
    # 处理 get 请求

    def get(self, request):
        # 获取未读消息
        notice_id = request.GET.get('notice_id')
        # 更新单条通知
        if notice_id:
            post = Post.objects.get(id=request.GET.get('post_id'))
            request.user.notifications.get(id=notice_id).mark_as_read()
            return redirect(post)
        # 更新全部通知
        else:
            request.user.notifications.mark_all_as_read()
            return redirect('notice:list')

```

## templates

网页的html文件

### accounts

有关账号的html

#### edit

```html
{% extends "base.html" %} 
{%load blog_extras%}
{% block main %}
<div class="container"style="opacity:0.7;">
    <br>
    <div class="row">
        <div class="col-12 text-center">
            <form method="post" action="." enctype="multipart/form-data">
                {% csrf_token %}
                <!-- phone -->
                {% if user.profile.img %}
                <div style="color:#E0FFFF">头像</div>
                <img src="{{ user.profile.img.url }}" style="max-width: 40%; border-radius: 35%;" class="col-md-4">
                {% else %}
                <h5 class=" text-center"style="color:#E0FFFF">暂无头像</h5>
                {% endif %}
                <div class="form-group">
                    <label for="img"style="color:#E0FFFF">上传头像</label>
                    <input type="file" class="form-control-file " style="color:#E0FFFF" id="img" name="img">
                </div>
                <div class="form-group ">
                    <label for="phone"style="color:#E0FFFF">电话</label>
                    <input type="text" class="form-control" id="phone" name="phone" style="color:#E0FFFF" value="{{ user.profile.phone }} ">
                </div>
                <!-- bio -->
                <div class="form-group ">
                    <label for="email"style="color:#E0FFFF">邮箱</label>
                    <textarea type="text" class="form-control" id="email" name="email">{{ user.profile.email }}</textarea>
                </div>
                <div class="form-group"style="color:#E0FFFF">
                    <label for="bio">简介</label>
                    <textarea type="text" class="form-control" id="bio" name="bio" rows="12">{{ user.profile.bio }}</textarea>
                </div>
                <!-- 提交按钮 -->
                <button class="btn btn-default float-right"><i class="fas fa-check" style="color:#E0FFFF"></i></button>
            </form>
        </div>
    </div>
</div>
{% endblock main %}
{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}
{% block toc_hidden %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc_hidden %}
```

#### login

```html
{%extends 'base.html'%}
{%load blog_extras%}
{%block main %}
<div class="container" style="margin: 6% 20%;opacity:0.7;">
    <div class="row">
        <div class="col-6">
            <form action="/login/" method="post" class="login-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="username" style="color:#E0FFFF">账号</label>
                    <input type="text" class="form-control" id="username" name="username" placeholder="Username">
                </div>
                <div class="form-group">
                    <label for="password" style="color:#E0FFFF">密码</label>
                    <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                </div>
                    <button class="btn btn-default float-right"><i class="fas fa-check" style="color:#E0FFFF"></i></button>
            </form>
        </div>
    </div>
</div>
{%endblock main%}

{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}

{% block toc_hidden %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc_hidden %}
```

#### register

```html
{%extends 'base.html'%}
{%load blog_extras%}
{%block main %}
<div class="container" style="margin: 6% 20%;opacity:0.7;">
    <div class="row">
        <div class="col-6">
        <form action="/register/" method="post" class="register-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="username" style="color:#E0FFFF">用户名：</label>
                <input type="text" name="username" id="id_username" placeholder="Username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password" style="color:#E0FFFF">密码：</label>
                <input type="password" name="password" id="password" placeholder="Password" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password2" style="color:#E0FFFF">确认密码：</label>
                <input type="password" name="password2" id="password2" placeholder="Repassword" class="form-control" required>
            </div>
            <button class="btn btn-default float-right"><i class="fas fa-check" style="color:#E0FFFF"></i></button>
        </form>
        </div>
    </div> 
</div>        
{%endblock main %}     
          
{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}

{% block toc_hidden %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc_hidden %}
```

### blog

有关文章的html

#### inclusions
##### _archives

```python
<h3 class="widget-title">归档</h3>
<ul>
    {% for date in date_list %}
        {% comment %} 解析视图函数对应的url模式
        第一个参数为端点值由冒号隔开第一部分为app_name
        第二部分为path中参数的值 {%endcomment %}
        <i class="fas fa-calendar-alt" style="color:#008B8B">&nbsp;</i>
        <a href="{% url 'blog:archive' date.year date.month%}"style="color:#FFF0F5">
            {{ date.year }} 年 {{ date.month }} 月
        </a>
        <br>
    {% empty %} 暂无归档！ {% endfor %}
</ul>
```

##### _categories

```python
<h3 class="widget-title">分类</h3>
<ul>
    {% for category in category_list %}
        <i class="fas fa-envelope-open-text" style="color:#F4A460">&nbsp;</i>
        <a href="{%url 'blog:category' category.pk%}"style="color:#FFF8DC">
            {{ category.name }}<span class="post-count">({{ category.num_posts }})</span>
        </a>
        <br>
    {% empty %} 暂无分类！ {% endfor %}
</ul>
```

##### _recent_posts

```python
<h3 class="widget-title">最新文章</h3>
<ul>
    {% for post in recent_post_list%}
        <i class="fas fa-file-alt" style="color:#DDA0DD">&nbsp;</i>
        <a href="{{post.get_absolute_url}}"style="color:#E6E6FA">{{post.title}}</a>
        <br>
    {%empty%} 暂无文章！ {%endfor%}
</ul>

```

##### _tags

```python
<h3 class="widget-title">标签</h3>
<ul>
    {% for tag in tag_list %}
        <i class="fas fa-tags"style="color:#87CEEB">&nbsp;</i>
        <a href="{%url 'blog:tag' tag.pk%}"style="color:#E0FFFF">{{ tag.name }}<span class="post-count">({{ tag.num_posts }})</span></a>
        <br>
    {% empty %} 暂无标签！ {% endfor %}
</ul>
```

#### detail

```python
{% extends 'base.html' %}
{% load comments_extras %}
{% block main %}
<article class="post post-{{ post.pk }}"style="background-color:rgba(255,255,255,0); ">
    <header class="entry-header">
        <h1 class="entry-title"style="color: #FFFAF0">{{ post.title }}</h1>
        <div align="center"style="color: #F0FFFF">
            <samll><small>
            <span><a><time class="entry-date"><i class="fas fa-clock"style="color:#008B8B"></i>&nbsp;{{ post.created_time }}&nbsp;&nbsp;&nbsp;</time></a></span>
            <span><a><i class="fas fa-feather-alt" style="color:#32CD32"></i>&nbsp;{{ post.author }}&nbsp;&nbsp;&nbsp;</a></span>
            <span><a><i class="fas fa-eye"style="color:#D2691E" ></i>&nbsp;{{ post.views }}&nbsp;&nbsp;&nbsp;</a></span>
            <span><a><i class="fas fa-thumbs-up" style="color:#FF0000"></i>&nbsp;{{ post.likes }}</a></span>
            </small></small>
        </div>
    </header>
    <div class="entry-content clearfix"style="color:#FFFAF0">
        {{ post.body_html|safe }}
    </div>
    <div style="text-align:center;" class="mt-4">
    <button class="btn btn-outline-danger"
            type="button"
            onclick="validate_is_like(
                     '{% url 'blog:increase_likes' post.id %}',
                     {{ post.id }},
                     {{ post.likes }}
                     )"
            >
        <span>点赞</span>
        <span><i class="fas fa-hand-holding-heart"></i></span>
        <span id="likes_number">{{ post.likes }}</span>
    </button>
</div>
</article>
<hr style="color:#FFFAF0">
<section class="comment-area" id="comment-area"style="background-color:rgba(255,255,255,0); ">
    {% if  user.is_authenticated %}
        {% show_comment_form post %}
        <hr>
    {% else %} 
    <div align="center">
        <big><big><a href="{% url 'accounts:login' %}"class="float-left"style="color: #F0FFFF">登录</a>
        <a href="{% url 'accounts:register' %}"class="float-right"style="color: #F0FFFF">注册</a></big></big>
    </div>
    <br>
    {% endif %}
    <div>
    {% show_comments user post %}
    </div>
</section>
{% endblock main %}

{% block toc %}
{% if post.toc %}
<div class="widget widget-content"style="background-color:rgba(255,255,255,0); ">
    <h3 class="widget-title" style="color: #FFFFF0">文章目录</h3>
    <div class="toc">
        <ul class="ul">
            {{ post.toc|safe }}
        <ul/>
    </div>
</div>
{% endif %}
{% endblock toc %}

{% block toc_hidden %}
{% if post.toc %}
<div class="widget widget-content"style="background-color:rgba(255,255,255,0); ">
    <h3 class="widget-title" style="color: #FFFFF0">文章目录</h3>
    <div class="toc">
        <ul class="ul">
            {{ post.toc|safe }}
        </>
    </div>
</div>
{% endif %}
{% endblock toc_hidden %}
```

#### index

```html
{% extends 'base.html'%}
{% load blog_extras %}
{% block main %} 
<br />
{% for post in post_list %}
<div class="row" style="text-align:left">
    <div class="col-12">
        <h2><b><a href="{{post.get_absolute_url}}"style="color:#E6E6FA"><i class="fas fa-file-alt" style="color:#DDA0DD">&nbsp;</i>{{ post.title }}</a></b></h2>
    </div>
    {% if post.image %}
    <div class="col-12">
        <a href="{{post.get_absolute_url}}">
            <img class="rounded" alt="Cinque Terre" src="{{ post.image_resize.url }}">
        </a>
    </div>
    {% endif %}
    <div class="col-12">
        <div><a href="{{post.get_absolute_url}}" style="color:#D3D3D3">{{post.summary}}...</a></div>
        <big><span><a href="{%url 'blog:category' post.category.pk %}"style="color:#FFF8DC"><i class="fas fa-envelope-open-text" style="color:#F4A460"></i>&nbsp;{{ post.category.name }}</a></span></big>
        <br>
        {% for tag in post.tags.all%}
        <a href="{%url 'blog:tag' tag.pk%}"style="color:#E0FFFF"><i class="fas fa-tags"style="color:#87CEEB">&nbsp;</i>{{ tag.name }}</a>
        {% endfor %}
        {% if post.tags.all %}<br>{% endif %}
        <samll><small>
        <span><a style="color:#F5F5F5"><time class="entry-date"><i class="fas fa-clock"style="color:#008B8B"></i>&nbsp;{{ post.created_time }}&nbsp;&nbsp;&nbsp;</time></a></span>
        <span><a style="color:#F5F5F5"><i class="fas fa-feather-alt" style="color:#32CD32"></i>&nbsp;{{ post.author }}&nbsp;&nbsp;&nbsp;</a></span>
        <span><a style="color:#F5F5F5"><i class="fas fa-eye"style="color:#D2691E" ></i>&nbsp;{{ post.views }}&nbsp;&nbsp;&nbsp;</a></span>
        <span><a style="color:#F5F5F5"><i class="fas fa-thumbs-up" style="color:#FF0000"></i>&nbsp;{{ post.likes }}</a></span>
        </small></small>
    </div>
</div>
<hr style="background-color:#F5FFFA">
{% empty %}
<div class="no-post"style="color:#F5F5F5">暂时还没有发布的文章！</div>
{% endfor %} 
{% if is_paginated %} 
{{ page_obj.render }}
{% endif %} 
{%endblock main %}
{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}
{% block toc_hidden %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc_hidden %}
```

### comments

评论有关的html文件

#### inclusions

##### _form

```html
<form action="{% url 'comments:comment' post.pk  %}" method="post" class="comment-form">
    <h3 style="color: #F0FFFF">发表评论</h3>
    {% csrf_token %}
    <div class="row">
        <div class="col-12">
            <div class="wmd-wrapper" id="id_text-wmd-wrapper">
                <textarea cols="40" id="id_text" name="text" rows="10" required=""></textarea>
            </div>
        </div>
        <div class="col-1 ml-auto">
            <button class="btn btn-default float-right"style="color: #F0FFFF"><i class="fas fa-comment-dots"style="font-size:30px"></i></button>
        </div>
    </div>
</form>
```

##### _list

```html
{% load mptt_tags %}
{% load static %}
<ul class="comment-list list-unstyled">
    {% for comment in comment_list %}
    <div class="row">
        <div class={% if comment.reply_to %}"col-11 ml-auto " style="background-color:rgba(255,255,255,0.1); "{% else %}"col-12"{% endif %}>
            <p>
                {% if comment.reply_to %}
                    {% if comment.reply_to.profile.img %}
                    <img class="rounded" alt="Cinque Terre" src="{{ comment.user.profile.img.url }}" height="50" width="50" >
                    {% endif %}
                    <strong style="color:#FFDEAD">
                        {{ comment.reply_to }}
                    </strong>
                    <i class="fas fa-reply-all" style="color: #F0FFFF"></i>
                {% endif %}
                {% if comment.user.profile.img %}
                    <img class="rounded" alt="Cinque Terre" src="{{ comment.user.profile.img.url }}" height="50" width="50" >
                {% endif %}
                <strong style="color:#E0FFFF">
                    {{ comment.user }}
                </strong>
            </p>
            <div style="color: #F0FFFF">{{ comment.text|safe }}</div>
            <div style="color: #F0FFFF;display: inline-block">
                {{ comment.created_time }}
            </div>
            <button class="btn byn-default" id="r{{comment.id}}" style="display:none;color:#E0FFFF"
                onclick="document.getElementById('b{{comment.id}}').style.display='';
                document.getElementById('f{{comment.id}}').style.display='none';
                document.getElementById('r{{comment.id}}').style.display='none';">
                <i class="fas fa-undo" style="font-size:30px"></i></button>
            {% if user.is_authenticated %}
            <form action="{% url 'comments:comment_reply' post.pk comment.id %}" id="f{{comment.id}}" method="post"
                class="comment-form" style="display:none">
                {% csrf_token %}
                <div class="row">
                    <div class="col-12">
                        <div class="wmd-wrapper" id="id_text-wmd-wrapper_reply{{comment.id}}">
                            <textarea cols="40" id="id_text{{comment.id}}" name="text" rows="10"></textarea>
                        </div>
                    </div>
                    <div class="col-1 ml-auto" >
                    <button class="btn btn-default float-right"   style="color: #E0FFFF;"
                        onclick="document.getElementById('b{{comment.id}}').style.display='';
                        document.getElementById('f{{comment.id}}').style.display='none';
                        document.getElementById('r{{comment.id}}').style.display='none';">
                        <i class="fas fa-comment-dots"style="font-size:30px"></i></button>
                    </div>
                </div>
            </form>
            <button class="btn btn-default" id="b{{comment.id}}" style="color: #F0FFFF "
                onclick="document.getElementById('b{{comment.id}}').style.display='none';
                document.getElementById('f{{comment.id}}').style.display='';
                document.getElementById('r{{comment.id}}').style.display='';
                editormd('id_text-wmd-wrapper_reply{{comment.id}}', {
                    watch: false, // 关闭实时预览
                    lineNumbers: false,
                    lineWrapping: false,
                    width: '100%',
                    height: 250,
                    placeholder: '在此输入评论',
                    // 当有多个mdeditor时，全屏后，其他mdeditor仍然显示，解决此问题。
                    onfullscreen: function () {
                        this.editor.css('border-radius', 0).css('z-index', 9999);
                    },
                    onfullscreenExit: function () {
                        this.editor.css({
                            zIndex: 10,
                            border: '1px solid rgb(221,221,221)'
                        })
                    },
                    syncScrolling: 'single',
                    path: '/static/mdeditor/js/lib/',
                    // theme
                    theme: 'dark',
                    previewTheme: 'dark',
                    editorTheme: 'lesser-dark',
                    autoFocus : false,
                    saveHTMLToTextarea: true, // editor.md 有问题没有测试成功
                    toolbarAutoFixed: true,
                    searchReplace: true,
                    emoji: true,
                    tex: true,
                    taskList: false,
                    flowChart: true,
                    sequenceDiagram: true,

                    // image upload
                    imageUpload: true,
                    imageFormats: ['jpg', 'JPG', 'jpeg', 'JPEG', 'gif', 'GIF', 'png', 'PNG', 'bmp',
                        'BMP',
                        'webp', 'WEBP'
                    ],
                    imageUploadURL: '/mdeditor/uploads/',
                    toolbarIcons: function () {
                        return ['bold', 'del', 'italic', '|',
                            'list-ul', 'list-ol', 'hr', '|',
                            'link', 'reference-link', 'image','table',
                            'emoji', 'html-entities', 'pagebreak', '|',
                            'help', 'info', '||',
                            'watch',
                        ]
                    },
                    onload: function () {
                        console.log('onload', this);
                        //this.fullscreen();
                        //this.unwatch();
                        //this.watch().fullscreen();

                        //this.setMarkdown('#PHP');
                        //this.width('100%');
                        //this.height(480);
                        //this.resize('100%', 640);
                    }
                });"><i class="fas fa-paper-plane"style="font-size:30px"></i></button></button>
            {% endif %}
            {% if not comment.is_leaf_node %}
            <div class="children">
                {{ children }}
            </div>
            {% endif %}
        </div>
        <div class={% if comment.reply_to %}"col-11 ml-auto "{% else %}"col-12"{% endif %}>
            <hr>
        </div>
    </div>
    {% empty %} <div style="color: #F0FFFF">暂无评论</div> {% endfor %}
</ul>
```

### interface

#### about

```html
{% extends 'base.html'%}
{% load blog_extras%}
{%block main %}
<div class="card-text" style="overflow: hidden">
                    <div class="row" style="text-align: center">
                        <div class="col-12 mt-4 font-body"style="color:#FDF5E6;">
                            <div>张耀文</div>
                            <div>%u5F20%u8000%u6587</div>
                            <div>D5C5D2ABCEC4</div>
                            <div>\u5F20\u8000\u658</div>
                            <code class="hljs nginx"><span class="err">Hello World</span></code>
                            <div>穷苦大学生，极度担忧头发</div>
                            <div>温州人，浙江理工大学</div>
                            <div>偏爱拖鞋背心</div>
                            <div>不抽烟，不喝酒，常常熬夜</div>
                            <div>不想开飞机的文科生不是一个优秀的计科学生</div>
                            <div>奔三的死宅</div>
                            <div>"ONE PIECE！是真实存在的！"</div>
                            <div>"这都只是你自己在钻牛角尖而已"</div>
                            <div>"有什么理由能够阻止一个男人奔向大海！"</div>
                            <div>"该活着的应该是具有生存意志的人"</div>
                            <div>哈哈哈哈哈哈哈哈哈哈</div>
                            <del>如果你愿意请我喝一杯咖啡</del>
                            <br><br><br>
                        </div>                     
                    </div>
                </div>
{%endblock main %}
{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}
{% block toc_hidden %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc_hidden %}
```

### notice

#### list

```html
{% extends "base.html" %}
{% load blog_extras %}
{% load notifications_tags %}
{% load static %}
{% block main %}
<div class="container">
    <div class="row mt-4 ml-4">
        <a href="{% url "notice:update" %}" class="btn btn-warning" role="button">清空所有通知</a>
    </div>
    <!-- 未读通知列表 -->
    <div class="row mt-2 ml-4">
        <ul class="list-group">
            {% for notice in notices %}
                <li class="list-group-item" id="notice_link">
                    <a href="{% url "notice:update" %}?post_id={{ notice.target.id }}&notice_id={{ notice.id }}"
                       target="_blank"
                    >
                    <span style="color: #5897fb;">
                        {{ notice.actor }}
                    </span>
                        在 <span style="color: #01a252;">{{ notice.target }}</span> {{ notice.verb }}。
                    </a>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ notice.timestamp|date:"Y/m/d H:i" }}
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

<style>
    #notice_link a:link {
        color: black;
    }

    #notice_link a:visited {
        color: lightgrey;
    }
</style>
{% endblock main %}
{% block toc %}
{%show_recent_posts%}
{%show_archives%}
{%show_categories%}
{%show_tags%}
{% endblock toc %}
```

### pure_pagination

#### pagination

```html
<div class="row pagination">
    <div class="m-auto">
            {% if page_obj.has_previous %}
            <span><a href="?{{ page_obj.previous_page_number.querystring }}" class="prev"><i class="fas fa-backward"style="color:#D0FFFF;"></i></a></span>
            {% else %}
            <span><span class="disabled prev"></span></span>
            {% endif %}
        {% for page in page_obj.pages %}
            {% if page %}
            {% ifequal page page_obj.number %}
            <span class="current"style="color:#D0FFFF;"><a href="#">{{ page }}</a></span>
            {% else %}
            <span><a href="?{{ page.querystring }}" class="page"style="color:#D0FFFF;">{{ page }}</a></span>
            {% endifequal %}
            {% else %}
            ...
            {% endif %}
        {% endfor %}
            {% if page_obj.has_next %}
            <span><a href="?{{ page_obj.next_page_number.querystring }}" class="next"><i class="fas fa-forward"style="color:#D0FFFF;"></i></a></span>
            {% else %}
            <span><span class="disabled next"></span></span>
            {% endif %}
    <div>
</div>
```

### base

```html
{%load static%}
{% load blog_extras %}
{% load notifications_tags %}
{% notifications_unread as unread_count %}
<!DOCTYPE html>
<html>

<head>
    <title>Iwan Blog</title>
    <!-- style -->
    <style>
        .codehilite {
        padding: 0;
        }

        /* for block of numbers */
        .hljs-ln-numbers {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;

        text-align: center;
        color: #ccc;
        border-right: 1px solid #CCC;
        vertical-align: top;
        padding-right: 5px;
        }

        .hljs-ln-n {
        width: 30px;
        }
        .hljs{
            opacity:0.6;
        }
        /* for block of code */
        .hljs-ln .hljs-ln-code {
        padding-left: 10px;
        white-space: pre;
        }
            #back_top {
            display: block;
            width: 40px;
            height: 40px;
            position: fixed;
            bottom: 60px;
            right: 40px;
            border-radius: 10px 10px 10px 10px;
            text-decoration: none;
            display: none;
            background-color: #FFFFF0;
        }

        #back_top span {
            display: block;
            width: 40px;
            color: #696969;
            font-size: 30px;
            text-align: center;
            margin-top: -3px;
        }

        #back_top span:hover {
            color: #cccccc;
        }
        .sidebar{
            will-change: min-height;
        }

        .sidebar__inner{
            transform: translate(0, 0); /* For browsers don't support translate3d. */
            transform: translate3d(0, 0, 0);
            will-change: position, transform;
        }  
        .wmd-wrapper ul {
            margin-left: 0px !important;
        }

        .wmd-wrapper ul li {
            list-style: disc !important;
        }

        .wmd-wrapper ul ul li {
            list-style: circle !important;
        }

        .wmd-wrapper h1,
        .wmd-wrapper h2,
        .wmd-wrapper h3,
        .wmd-wrapper h4,
        .wmd-wrapper h5,
        .wmd-wrapper h6 {
            background: #ffffff !important;
            color: #000000 !important;
        }

        .wmd-wrapper h2,
        .wmd-wrapper h3,
        .wmd-wrapper h4 {
            padding: 0px !important;
        }

        .wmd-wrapper h5 {
            letter-spacing: 0px !important;
            text-transform: none !important;
            font-size: 1em !important;
        }

        .wmd-wrapper h6 {
            font-size: 1em !important;
            color: #777 !important;
        }
        
        html, body {
            height: 100%;
            margin: 0;
        }

        #wrapper {
            min-height: 100%;
            margin-bottom: -60px;
        }

        #footer,
        #push {
            height: 60px;
        }

        #bg_black{
            position:fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            min-width: 1000px;
            z-index:-10;
            zoom: 1;
            background-repeat: no-repeat;
            background-size: cover;
            -webkit-background-size: cover;
            -o-background-size: cover;
            background-position: center 0;
        }
        #bg_asuka{
            position:fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            min-width: 1000px;
            z-index:-20;
            zoom: 1;
            background-repeat: no-repeat;
            background-size: cover;
            -webkit-background-size: cover;
            -o-background-size: cover; 
            background-position: center 0;
        }
        ul li a{ color:#FFFFF0;}
    </style>
    <!-- meta -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- css -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.15.8/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/aplayer/1.9.1/APlayer.min.css">
    <link rel="stylesheet" href="/static/mdeditor/css/editormd.min.css">
    <link rel="stylesheet" href="{% static 'css/pace.css' %}" />
    <link rel="stylesheet" href="{% static 'css/custom.css' %}" />
    <link rel="stylesheet" href="{% static 'css/button.min.css' %}" />
    <!-- js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/aplayer/1.9.1/APlayer.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/editor-md/1.5.0/editormd.min.js"></script>
    <script src="{% static 'js/pace.min.js' %}"></script>
    <script src="{% static 'js/modernizr.custom.js' %}"></script>
    
</head>
<body>
    <div id="bg_black" style="background:#000000;width:100%;height:100%;opacity:0.4;"></div>
    <div id="bg_asuka" style="background-image: url({% static 'img/asuka.png'%});width:100%;height:100%;opacity:1.0;"></div>
    <nav class="navbar navbar-expand-lg bg-dark"style="opacity:0.8;z-index:999">
        <div class="container">
            <a class="navbar-brand" href="{% url 'blog:index' %}" style="color: #D8BFD8;">Iwan Blog</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar"
            aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fas fa-bars" style="font-size: xx-large;color:#FDF5E6;"></i>
            </button>
            <div class="collapse navbar-collapse " id="navbar">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'blog:index' %}" style="color: #D8BFD8;">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'interface:about' %}" style="color: #D8BFD8;">关于</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'interface:admin' %}" style="color:#D8BFD8;">管理</a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" 
                            href="#" id="navbarDropdown" 
                            style="color: #D8BFD8;" 
                            role="button" 
                            data-toggle="dropdown" 
                            aria-haspopup="true" 
                            aria-expanded="false"
                        >
                        {% if unread_count %}
                            <svg viewBox="0 0 8 8"
                                width="8px"
                                height="8px">
                                <circle cx="4"
                                        cy="4"
                                        r="4"
                                        fill="#ff6b6b"
                                        ></circle>
                            </svg>
                        {% endif %}
                        {{user.username }}</a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{% url 'notice:list'%}">通知{% if unread_count %}<span class="badge badge-danger">{{ unread_count }}</span>{% endif %}</a>                     
                            <a class="dropdown-item" href="{% url "accounts:edit" user.id %}">信息</a>

                            <a class="dropdown-item" href="{% url 'accounts:logout' %}">登出</a>
                        </div>
                    </li>
                    {% else %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" 
                            href="#" 
                            style="color: #D8BFD8;" 
                            role="button" 
                            data-toggle="dropdown" 
                            aria-haspopup="true" 
                            aria-expanded="false">
                        账号</a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{% url 'accounts:login' %}">登录</a>
                            <a class="dropdown-item" href="{% url 'accounts:register' %}">注册</a>
                        </div>
                    </li>
                    {% endif %}
                    <li>
                        <div id="header-search-box">
                            <a id="search-menu" href="#"> 
                                <span id="search-icon" class="ion-ios-search-strong" style="color:#D8BFD8"></span>
                            </a>
                            <div id="search-form" class="search-form">
                                <form role="search" method="get" id="searchform" action="{% url 'blog:search' %}">
                                    <input type="search" name="q" placeholder="Search" required>
                                        <i class="fas fa-search"style="color:#D8BFD8"></i>
                                    <button type="submit"><span class="ion-ios-search-strong"></span></button>
                                </form>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>    
    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        {{ message }}
    </div>
    {% endfor %} {% endif %}
    <div id="wrapper">
        <div class="container">
            <nav class="navbar navbar-light d-md-none">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#hidden-side"
                    aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-file-contract" style="font-size: xx-large;color:#FDF5E6;"></i>
                </button>
            </nav>
            <div class="collapse" id="hidden-side"style="background-color:rgba(255,255,255,0); ">
                <div class="ml-4 mr-4">
                    <div class="card-body" style="padding: 20px 0 0 0; overflow: auto;">
                            <!-- 目录 -->
                        <div class="card-text" style="overflow: hidden">
                            <br>
                            {% if  user.is_authenticated %}
                            <li style="color:#FFFFFF">
                                <big>当前在线：{{ user.username }}</big>
                            </li>
                            {% endif %}
                            <div id="aplayer_collapse"></div>
                            <div style="color:#FFFFFF;">
                                {% block toc_hidden %}
                                {% endblock toc_hidden %}
                                <div align="center">
                                <h2 style="display:inline-block">
                                    <a href="https://github.com/Iwannnn">
                                        <i class="fab fa-github"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#QQ">
                                        <i class="fab fa-qq"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#WeChat">
                                        <i class="fab fa-weixin"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a  href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#Coffee">
                                        <i class="fas fa-coffee"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>    
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="{% url 'rss' %}">
                                        <i class="fas fa-rss"style="color:#FDF5E6;"></i>
                                    </a>       
                                </h2>
                                </div>  
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">      
                <div class="col-xs-12 col-md-8">
                    <main>
                        {%block main %}
                        {%endblock main%}
                    </main>
                </div>
                <div class="col-md-4 card d-none d-md-block collapse sidebar"style="background-color:rgba(255,255,255,0); ">
                    <div id="right_sidebar">
                        <div class="sidebar__inner">
                            <br>
                            {% if  user.is_authenticated %}
                            <li style="color:#FFFFFF">
                                <big>当前在线：{{ user.username }}</big>
                                <br>
                            </li>
                            {% endif %}
                            <div id="aplayer"></div>
                            <div style="color:#FFFFFF;">
                                {% block toc %}
                                {% endblock toc %}
                            </div>
                            <div align="center">
                                <h2 style="display:inline-block">
                                    <a href="https://github.com/Iwannnn">
                                        <i class="fab fa-github"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#QQ">
                                        <i class="fab fa-qq"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#WeChat">
                                        <i class="fab fa-weixin"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a  href="javascript:void(0);" class="no-underline" data-toggle="modal" data-target="#Coffee">
                                        <i class="fas fa-coffee"style="color:#FDF5E6;"></i>
                                    </a>
                                </h2>    
                                &nbsp;&nbsp;&nbsp;
                                <h2 style="display:inline-block">
                                    <a href="{% url 'rss' %}">
                                        <i class="fas fa-rss"style="color:#FDF5E6;"></i>
                                    </a>       
                                </h2>
                            </div>  
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <a id="back_top" href="script:;"><span><i class="fas fa-hand-middle-finger"></i></span></a>
            </div>
        </div>
        <div id="push"></div>
    </div>
    <footer id ="footer" class='navbar-fixed-bottom bg-dark'style="opacity:0.7;">
        <div align="center">
            <big><strong style="color:#FDF5E6">Iwan Blog</strong></big>
        </div>
        <div align="center">
            <small><a href="https://beian.miit.gov.cn"style="color:#FDF5E6;">Powered by 浙ICP备2021004697号-1</a></small>
        </div>
    </footer>
    <div class="modal fade" id="QQ" tabindex="-1" role="dialog"
        aria-labelledby="QQ" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img src="{% static 'img/QQ.jpg'%}"
                        style="max-width: 100%"
                        alt="img"
                    >
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="WeChat" tabindex="-1" role="dialog"
        aria-labelledby="WeChat" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img src="{% static 'img/WeChat.jpg'%}"
                        style="max-width: 100%"
                        alt="img"
                    >
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="Coffee" tabindex="-1" role="dialog"
        aria-labelledby="Coffee" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img src="{% static 'img/Coffee.jpg'%}"
                        style="max-width: 100%"
                        alt="img"
                    >
                </div>
            </div>
        </div>
    </div>
    <script>
        var ap = new APlayer({
            element: document.getElementById('aplayer'),
            mini: false,
            autoplay: false,
            theme: '#FADFA3',
            loop: 'all',
            order: 'random',
            preload: 'auto',
            volume: 0.7,
            mutex: true,
            listFolded: false,
            listMaxHeight: 90,
            lrcType: 3,
            audio:[
                {
                    /*歌名*/
                    title: 'One Last Kiss',
                    /*作者*/
                    author: '宇多田光',
                    /*歌曲*/
                    url: "{% static 'bgm/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).mp3'%}",
                    /*音乐专辑图片*/
                    pic: "{% static 'img/rei.jpg'%}",
                    /*歌词*/
                    lrc: "{% static 'lrc/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).lrc'%}",
                },

            ]
        });
    </script>
    <script>
        var ap = new APlayer({
            element: document.getElementById('aplayer_collapse:'),
            mini: false,
            autoplay: false,
            theme: '#FADFA3',
            loop: 'all',
            order: 'random',
            preload: 'auto',
            volume: 0.7,
            mutex: true,
            listFolded: false,
            listMaxHeight: 90,
            lrcType: 3,
            audio:[
                {
                    /*歌名*/
                    title: 'One Last Kiss',
                    /*作者*/
                    author: '宇多田光',
                    /*歌曲*/
                    url: "{% static 'bgm/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).mp3'%}",
                    /*音乐专辑图片*/
                    pic: "{% static 'img/rei.jpg'%}",
                    /*歌词*/
                    lrc: "{% static 'lrc/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).lrc'%}",
                },

            ]
        });
    </script>
    <script>
        var ap = new APlayer({
            element: document.getElementById('aplayer_collapse'),
            mini: false,
            autoplay: false,
            theme: '#FADFA3',
            loop: 'all',
            order: 'random',
            preload: 'auto',
            volume: 0.7,
            mutex: true,
            listFolded: false,
            listMaxHeight: 90,
            lrcType: 3,
            audio:[
                {
                    /*歌名*/
                    title: 'One Last Kiss',
                    /*作者*/
                    author: '宇多田光',
                    /*歌曲*/
                    url: "{% static 'bgm/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).mp3'%}",
                    /*音乐专辑图片*/
                    pic: "{% static 'img/rei.jpg'%}",
                    /*歌词*/
                    lrc: "{% static 'lrc/宇多田光 (宇多田ヒカル) - One Last Kiss (试听版).lrc'%}",
                },

            ]
        });
    </script>
    <script>
        $(function () {
            for (var i = 0; i < 100; i++) {
                $("#article").append("<p>xxxxxxxxxx<br></p>")
            }

        })
    </script>
    <script>
        $(function () {
            $(window).scroll(function () { //只要窗口滚动,就触发下面代码 
                var scrollt = document.documentElement.scrollTop + document.body.scrollTop; //获取滚动后的高度 
                if (scrollt > 200) { //判断滚动后高度超过200px,就显示  
                    $("#back_top").fadeIn(400); //淡出     
                } else {
                    $("#back_top").stop().fadeOut(400); //如果返回或者没有超过,就淡入.必须加上stop()停止之前动画,否则会出现闪动   
                }
            });
            $("#back_top").click(function () { //当点击标签的时候,使用animate在200毫秒的时间内,滚到顶部
                $("html,body").animate({
                    scrollTop: "0px"
                }, 200);
            });
        });
    </script>
    <script src="{% static 'js/jquery.sticky-sidebar.min.js' %}"></script>
    <script type="text/javascript">
            $(() => {
                $('#left_sidebar').stickySidebar({
                    topSpacing: 0,
                    bottomSpacing: 20,
                });
                $('#right_sidebar').stickySidebar({
                    topSpacing: 0,
                    bottomSpacing: 20,
                });
            });
        
    </script>
    <script type="text/javascript">
        $(function () {
            
            editormd("id_text-wmd-wrapper", {
                watch: false, // 关闭实时预览
                lineNumbers: false,
                lineWrapping: false,
                width: "100%",
                height: 300,
                placeholder: '在此输入评论',
                
                autoFocus : false,
                // 当有多个mdeditor时，全屏后，其他mdeditor仍然显示，解决此问题。
                onfullscreen: function () {
                    this.editor.css("border-radius", 0).css("z-index", 9999);
                },
                onfullscreenExit: function () {
                    this.editor.css({
                        zIndex: 10,
                        border: "1px solid rgb(221,221,221)"
                    })
                },
                syncScrolling: "single",
                path: "/static/mdeditor/js/lib/",
                // theme
                theme: "dark",
                previewTheme: "dark",
                editorTheme: "lesser-dark",

                saveHTMLToTextarea: true, // editor.md 有问题没有测试成功
                toolbarAutoFixed: true,
                searchReplace: true,
                emoji: true,
                tex: true,
                taskList: false,
                flowChart: true,
                sequenceDiagram: true,
                
                // image upload
                imageUpload: true,
                imageFormats: ['jpg', 'JPG', 'jpeg', 'JPEG', 'gif', 'GIF', 'png', 'PNG', 'bmp',
                    'BMP',
                    'webp', 'WEBP'
                ],
                imageUploadURL: "/mdeditor/uploads/",
                toolbarIcons: function () {
                    return ['bold', 'del', 'italic', '|',
                        'list-ul', 'list-ol', 'hr', '|',
                        'link', 'reference-link', 'image','table',
                        'emoji', 'html-entities', 'pagebreak', '|',
                        'help', 'info', '||',
                        'watch',
                    ]
                },
                onload: function () {
                    console.log('onload', this);
                    //this.fullscreen();
                    //this.unwatch();
                    //this.watch().fullscreen();

                    //this.setMarkdown("#PHP");
                    //this.width("100%");
                    //this.height(480);
                    //this.resize("100%", 640);
                }
                
            });
        });
    </script>
    <script src="{% static 'js/csrf.js' %}"></script>
    <script>
        // 点赞功能主函数
        function validate_is_like(url, id, likes) {
            // 取出 LocalStorage 中的数据
            let storage = window.localStorage;
            const storage_str_data = storage.getItem("my_post_data");
            let storage_json_data = JSON.parse(storage_str_data);
            // 若数据不存在，则创建空字典
            if (!storage_json_data) {
                storage_json_data = {}
            };
            // 检查当前文章是否已点赞。是则 status = true
            const status = check_status(storage_json_data, id);
            if (status) {
                layer.msg('已经点过赞了哟~');
                // 点过赞则立即退出函数
                return;
            } else {
                // 用 Jquery 找到点赞数量，并 +1
                $('span#likes_number').text(likes + 1).css('color', '#dc3545');
            }
            // 用 ajax 向后端发送 post 请求
            $.post(
                url,
                // post 只是为了做 csrf 校验，因此数据为空
                {},
                function(result) {
                    if (result === 'success') {
                        // 尝试修改点赞数据
                        try {
                            storage_json_data[id] = true;
                        } catch (e) {
                            window.localStorage.clear();
                        };
                        // 将字典转换为字符串，以便存储到 LocalStorage
                        const d = JSON.stringify(storage_json_data);
                        // 尝试存储点赞数据到 LocalStorage
                        try {
                            storage.setItem("my_post_data", d);
                        } catch (e) {
                            // code 22 错误表示 LocalStorage 空间满了
                            if (e.code === 22) {
                                window.localStorage.clear();
                                storage.setItem("my_post_data", d);
                            }
                        };
                    } else {
                        layer.msg("与服务器通信失败..过一会儿再试试呗~");
                    }
                }
            );
        };

        // 辅助点赞主函数，验证点赞状态
        function check_status(data, id) {
            // 尝试查询点赞状态
            try {
                if (id in data && data[id]) {
                    return true;
                } else {
                    return false;
                }
            } catch (e) {
                window.localStorage.clear();
                return false;
            };
        };
    </script>
    <script src="{% static 'js/script.js' %}"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
    <script src="https://cdn.bootcss.com/highlightjs-line-numbers.js/2.7.0/highlightjs-line-numbers.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        hljs.initLineNumbersOnLoad();
    </script>
</body>
</html>

```

# 部署

将这个博客项目部署到服务器上

## 部署准备

1. 一个可以通过外网访问的服务器
2. 一个域名

## 配置服务器

我选择的服务器是阿里云的CentOS 7.3，需要先在服务器中先创建一个superuser，再更新服务器自带的python和sqlite。
先将代码上传到Github上，在服务器中安装git，拉取代码。再利用pipenv安装pipfile/pipfile.lock中记录的需要的库。
django官方文档推荐runserver仅用于开发测试而不用于生产测试，所以采用Gunicorn来启动线上环境的服务器。
Nginx (engine x) 是一个高性能的 HTTP 和反向代理 web 服务器，它的功能非常多，这里我们主要用它来处理静态文件以及将非静态文件的请求反向代理给Gunicorn。在/etc/nginx/conf.d/ 下新建配置文件写入

```
server {
    charset utf-8;
    listen 80;
    server_name iwannnn.cn;

    location /static {
        alias /home/iwan/apps/Iwan_Blog/static;
    }

    location / {
        proxy_set_header Host $host;
        proxy_pass http://127.0.0.1:8000;
    }
}
```
这样nginx就能在alias下的目录找到请求的文件返回给客户端了。
在代码目录下运行命令```pipenv run python manage.py collectstatic```就能收集静态文件到STATIC_ROOT中了
gunicorn是手动启动的，退出了shell，博客就会无法访问，使用supervisor来管理gunicorn，可以让他自动启动避免麻烦。
自动化部署，当更改了本地文件后服务器上的的文件也要更改，但是重新到服务器里输入一大堆命令很麻烦。所以利用fabric实现自动化部署
```python
from fabric import task
from invoke import Responder
from _credentials import github_username, github_password


def _get_github_auth_responders():
    """
    返回 GitHub 用户名密码自动填充器
    """
    username_responder = Responder(
        pattern="Username for 'https://github.com':",
        response='{}\n'.format(github_username)
    )
    password_responder = Responder(
        pattern="Password for 'https://{}@github.com':".format(
            github_username),
        response='{}\n'.format(github_password)
    )
    return [username_responder, password_responder]


@task()
def deploy(c):
    supervisor_conf_path = '~/etc/'
    supervisor_program_name = 'Iwan_Blog'

    project_root_path = '~/apps/Iwan_Blog/'

    # 先停止应用
    with c.cd(supervisor_conf_path):
        cmd = 'supervisorctl stop {}'.format(supervisor_program_name)
        c.run(cmd)
    # 进入项目根目录，从 Git 拉取最新代码
    with c.cd(project_root_path):
        cmd = 'git pull'
        responders = _get_github_auth_responders()
        c.run(cmd, watchers=responders)
    # 安装依赖，迁移数据库，收集静态文件
    with c.cd(project_root_path):
        c.run('~/.local/bin/pipenv install --skip-lock')
        c.run('~/.local/bin/pipenv run python manage.py migrate')
        c.run('~/.local/bin/pipenv run python manage.py collectstatic --noinput')
    # 重新启动应用
    with c.cd(supervisor_conf_path):
        cmd = 'supervisorctl start {}'.format(supervisor_program_name)
        c.run(cmd)

```
这样执行一个命令``` pipenv run fab -H iwan@47.98.63.97:22 --prompt-for-login-password -p deploy```就可以同步了。

## 申请https证书

安装certbot python2-certbot-nginx运行命令```sudo certbot --nginx```跟着提示完成就开启了全站HTTPS

## TODO

使用DOCKER